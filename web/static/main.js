function byId(id){return document.getElementById(id)}
function show(el){el.classList.remove('hidden')}
function hide(el){el.classList.add('hidden')}
function radioVal(name){let els=document.getElementsByName(name);for(let i=0;i<els.length;i++){if(els[i].checked){return els[i].value}}return null}
function today(){let d=new Date();return d.toISOString().slice(0,10)}
function yearAgo(){let d=new Date();d.setDate(d.getDate()-365);return d.toISOString().slice(0,10)}
function initDates(){byId('sd').value=yearAgo();byId('ed').value=today()}
async function postForm(path, formData){let r=await fetch(path,{method:'POST',body:formData});return r.json()}
async function getJson(path){let r=await fetch(path);return r.json()}
function renderPlotly(divId, fig){Plotly.newPlot(divId, fig.data, fig.layout)}
function setMain(){let v=radioVal('main');let left=byId('left');let right=byId('right');if(v==='single'){show(left);hide(right)}else{show(right);hide(left)}}
async function uploadMap(){let f=byId('map_upload').files[0];if(!f) return;let fd=new FormData();fd.append('file',f);let j=await postForm('/upload-mapping',fd);alert(JSON.stringify(j))}
async function runSingle(){let q=byId('q').value.trim();let ind=byId('ind').value.trim();let sd=byId('sd').value;let ed=byId('ed').value;let res=await getJson('/resolve?query='+encodeURIComponent(q));if(!res.ok){alert('未识别证券');return}let symbol=res.symbol;let j=await getJson('/single/analysis?symbol='+encodeURIComponent(symbol)+'&industry='+encodeURIComponent(ind)+'&start='+sd+'&end='+ed+'&freq=d&ma_short=20&ma_long=60');if(!j.ok){alert('分析失败');return}let container=byId('single_result');container.innerHTML='';let kDiv=document.createElement('div');kDiv.id='fig_k_div';container.appendChild(kDiv);renderPlotly('fig_k_div',j.fig_k);let adv=document.createElement('div');adv.innerText=j.advisor;container.appendChild(adv)}
async function runIndustry(){let ind=byId('industry_sel').value.trim();let syms=(byId('symbols_sel').value.trim()||'').split(',').map(s=>s.trim()).filter(s=>s.length>0);let w=byId('weights_json').value.trim();let fd=new FormData();fd.append('industry',ind);fd.append('symbols_json',JSON.stringify(syms));fd.append('weights_json',w);let j=await postForm('/industry/score',fd);let container=byId('industry_result');container.innerHTML='';if(!j.ok){container.innerText='无评分数据';return}let tbl=document.createElement('table');let thead=document.createElement('thead');let trh=document.createElement('tr');['symbol','score_profitability','score_solvency','score_growth','score_return','composite_score'].forEach(h=>{let th=document.createElement('th');th.innerText=h;trh.appendChild(th)});thead.appendChild(trh);tbl.appendChild(thead);let tb=document.createElement('tbody');j.score.forEach(r=>{let tr=document.createElement('tr');['symbol','score_profitability','score_solvency','score_growth','score_return','composite_score'].forEach(k=>{let td=document.createElement('td');td.innerText=r[k];tr.appendChild(td)});tb.appendChild(tr)});tbl.appendChild(tb);container.appendChild(tbl);j.reports.forEach(rp=>{let d=document.createElement('div');d.innerText=rp.text;container.appendChild(d)})}
document.addEventListener('DOMContentLoaded',()=>{initDates();setMain();document.getElementsByName('main').forEach(el=>el.addEventListener('change',setMain));byId('btn_upload').addEventListener('click',uploadMap);byId('run_single').addEventListener('click',runSingle);byId('run_industry').addEventListener('click',runIndustry)})
